<!doctype html>
<html>

<head>
  <style>
    .pentaho-visual-base-Model {
      border: solid 1px #005da6;
    }
  </style>

  <script type="module">
    import loader from "./node_modules/@pentaho/viz-api/loader.js";

    loader.config({
      baseUrl: "./node_modules/@pentaho/viz-api/",
      application: "my-app",
      debug: false,
      paths: {
        "pentaho-visual-samples-bar-d3": ".",
        "d3": "./node_modules/d3/build/d3"
      }
    });

    loader([
      "pentaho-visual-samples-bar-d3/Model",
      "pentaho/visual/base/View",
      "pentaho/data/Table",
      "json!./sandbox-data.json"
    ]).then(function([BarModel, BaseView, Table, dataSpec]) {

      // Create the visualization model.
      const modelSpec = {
        "data": new Table(dataSpec),
        "category": {fields: ["productFamily"]},
        "measure": {fields: ["sales"]}
      };

      const model = new BarModel(modelSpec);

      // Create the visualization view.
      const viewSpec = {
        width: 1400,
        height: 300,
        domContainer: document.getElementById("viz_div"),
        model: model
      };

      // These are responsibilities of the visualization container application:
      // 1. Mark the container with the model's CSS classes, for styling purposes.
      viewSpec.domContainer.className = model.$type.inheritedStyleClasses.join(" ");

      // 2. Set the DOM container dimensions.
      viewSpec.domContainer.style.width = viewSpec.width + "px";
      viewSpec.domContainer.style.height = viewSpec.height + "px";

      // Create the visualization view.
      BaseView.createAsync(viewSpec)
        .then(function(view) {
          // Handle the execute action.
          view.on("pentaho/visual/action/Execute", {
            "do": function(event, action) {
              alert("Executed " + action.dataFilter.$contentKey);
            }
          });

          // Handle the select action.
          view.on("pentaho/visual/action/Select", {
            "finally": function(event, action) {
              document.getElementById("messages_div").innerText =
                "Selected: " + view.model.selectionFilter.$contentKey;
            }
          });

          // Render the visualization.
          return view.update();
        }, onError);
    }, onError);

    function onError(error) {
      alert(error.message);
    }
  </script>
</head>
<body>
  <!-- div that will contain the visualization -->
  <div id="viz_div"></div>

  <!-- div that will display messages -->
  <div id="messages_div"></div>
</body>
</html>
